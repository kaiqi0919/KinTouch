# マスターキーカード機能 - 実装ガイド

## 概要
打刻修正機能に**マスターキーカード認証**を追加しました。従来のパスワード認証に加えて、登録されたマスターキーカードをかざすことでも打刻修正画面にアクセスできるようになりました。

## 主な変更点

### 1. データベース構造の拡張
新しいテーブル `master_keys` を追加しました：

```sql
CREATE TABLE master_keys (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    card_uid TEXT UNIQUE NOT NULL,
    description TEXT,
    created_at TIMESTAMP NOT NULL,
    is_active INTEGER DEFAULT 1
)
```

**フィールド説明:**
- `card_uid`: マスターキーカードの一意識別子
- `description`: カードの説明（例：「管理者用」「予備キー」など）
- `created_at`: 登録日時
- `is_active`: 有効/無効フラグ（1=有効、0=無効）

### 2. 新しい認証フロー

#### 打刻修正へのアクセス方法
メニューから「5. 打刻修正」を選択すると、認証画面が表示されます：

**方法1: パスワード認証**
- パスワードを入力して「認証」ボタンをクリック
- 正しいパスワードで打刻修正画面へ

**方法2: マスターキーカード認証**
- 使用するリーダー（授業用/会議用）を選択
- 登録済みのマスターキーカードをかざす
- 認証成功で打刻修正画面へ

### 3. マスターキー管理機能

#### アクセス方法
打刻修正の認証画面から「マスターキー管理」ボタンをクリック
→ パスワード認証が必要（セキュリティのため）

#### 機能一覧

**マスターキーの追加:**
1. 「追加」ボタンをクリック
2. 使用するリーダーを選択
3. 登録したいカードをかざす
4. 説明を入力（任意）
5. 「登録」ボタンをクリック

**マスターキーの削除:**
1. 一覧から削除したいマスターキーを選択
2. 「削除」ボタンをクリック
3. 確認ダイアログで「はい」を選択

**マスターキー一覧の表示:**
- カードUID
- 説明
- 登録日時
- 状態（有効/無効）

### 4. セキュリティ機能

- **二重認証**: マスターキー管理画面へのアクセスには必ずパスワードが必要
- **カード検証**: 打刻修正時に、かざされたカードがマスターキーとして登録されているか確認
- **音声フィードバック**: 
  - 認証成功時: 成功音
  - 未登録カード検出時: エラー音
- **視覚的フィードバック**: ステータスラベルの色変化（青→緑/赤）

## 使用例

### 初回セットアップ
1. システムを起動
2. メニューから「5. 打刻修正」を選択
3. パスワードで認証
4. 「マスターキー管理」をクリック
5. パスワードを再入力
6. 「追加」ボタンから管理者用カードを登録

### 日常的な使用
1. メニューから「5. 打刻修正」を選択
2. マスターキーカードをかざす
3. 認証成功後、打刻修正を実行

## データベース関数

### 新規追加された関数

**`is_master_key(card_uid)`**
- カードUIDがマスターキーとして登録されているか確認
- 戻り値: True/False

**`add_master_key(card_uid, description="")`**
- 新しいマスターキーを登録
- 戻り値: 成功時True、失敗時False

**`get_master_keys()`**
- 登録されているマスターキーの一覧を取得
- 戻り値: マスターキー情報の辞書リスト

**`delete_master_key(card_uid)`**
- マスターキーを削除
- 戻り値: 成功時True、失敗時False

## 技術的な詳細

### ファイル変更
1. **`modules/database_manager.py`**
   - `master_keys` テーブルの初期化
   - マスターキー管理関数の追加

2. **`出退勤確認システム.py`**
   - `show_attendance_correction()`: 認証画面への遷移
   - `show_correction_auth()`: 新しい認証画面
   - `show_master_key_management()`: マスターキー管理画面
   - `show_add_master_key()`: マスターキー追加画面
   - `show_correction_screen()`: 打刻修正画面（認証後）

### カード監視ロジック
```python
def check_master_card():
    # カードの存在確認
    if is_card_present(reader):
        # カード接続
        connection = connect_to_card(reader)
        # UID取得
        uid = get_card_uid(connection)
        # マスターキー確認
        if is_master_key(uid):
            # 認証成功
            show_correction_screen()
        else:
            # エラー表示
```

## トラブルシューティング

### カードが認識されない
- リーダーの接続を確認
- 正しいリーダー（授業用/会議用）を選択しているか確認
- カードをリーダーに正しく近づける

### マスターキーが登録できない
- 既に登録済みのカードではないか確認
- データベースファイル（`data/attendance.db`）の権限を確認

### 認証画面から進めない
- パスワードが正しいか確認
- マスターキーが正しく登録されているか「マスターキー管理」で確認

## 今後の拡張案

- マスターキーの有効期限設定
- マスターキー使用履歴の記録
- 複数レベルの権限設定（閲覧のみ、編集可能など）
- マスターキーの一時無効化機能

## 注意事項

⚠️ **重要**: マスターキーカードは管理者のみが保管してください。紛失した場合は速やかに該当カードを削除してください。

⚠️ **セキュリティ**: パスワードとマスターキーカードの両方を適切に管理してください。

---

**実装日**: 2026年2月22日  
**バージョン**: 1.0  
**対応システム**: 出退勤確認システム（モジュール化バージョン）

# 出退勤確認システム（複数リーダー対応版）

## 概要
SC300カードリーダーを2台使用して、授業用と会議用の出退勤を別々に管理するシステムです。

### ビルド
pyinstaller --onefile 出退勤確認システム.py


## 主な機能

### 1. 複数リーダー対応
- **授業用リーダー**: `time_records` テーブルに記録
- **会議用リーダー**: `meeting_records` テーブルに記録
- 2つのリーダーを同時に監視し、それぞれ独立して打刻処理

### 2. 2分割UI
```
┌─────────────────────────────────────────┐
│         打刻受付                        │
├──────────────────┬──────────────────────┤
│   授業用         │    会議用            │
│ [打刻情報表示]   │  [打刻情報表示]      │
└──────────────────┴──────────────────────┘
```

### 3. 集計機能の拡張
すべての集計画面で「授業用/会議用」を選択可能：
- 打刻表示
- 打刻サマリー
- 日次集計（CSV出力）
- 月次集計（CSV出力）

## セットアップ

### 1. 必要なライブラリ
```bash
pip install pyscard
```

### 2. リーダーの接続
- 2台のSC300カードリーダーをPCに接続
- 初回起動時にリーダー設定画面が表示されます

### 3. リーダー設定
1. システムを起動
2. 検出された2台のリーダーから、授業用と会議用を選択
3. 設定を保存

設定は `reader_config.json` に保存され、次回起動時に自動的に読み込まれます。

## データベース構造

### time_records（授業用）
```sql
CREATE TABLE time_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    instructor_id INTEGER,
    card_uid TEXT NOT NULL,
    instructor_name TEXT NOT NULL,
    record_type TEXT NOT NULL CHECK (record_type IN ('IN', 'OUT')),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

### meeting_records（会議用）
```sql
CREATE TABLE meeting_records (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    instructor_id INTEGER,
    card_uid TEXT NOT NULL,
    instructor_name TEXT NOT NULL,
    record_type TEXT NOT NULL CHECK (record_type IN ('IN', 'OUT')),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)
```

## メニュー構成

1. **打刻受付**: 2分割画面で授業用・会議用を同時監視
2. **講師一覧**: 登録済み講師の確認（授業用/会議用共通）
3. **打刻表示**: 特定日の打刻記録を表示（種別選択可能）
4. **打刻サマリー**: 当日の出退勤状況をサマリー表示（種別選択可能）
5. **打刻修正**: 手動で打刻を追加・修正（種別選択可能）
6. **音量設定**: ビープ音のON/OFF
7. **日次集計**: 日次のCSVエクスポート（種別選択可能）
8. **月次集計**: 月次のCSVエクスポート（種別選択可能）
9. **リーダー設定**: リーダーの割り当て変更
0. **終了**: アプリケーション終了

## CSVエクスポート

### 日次集計
- ファイル名: `log/YYYY-MM/attendance_records_YYYY-MM-DD_授業.csv` または `_会議.csv`
- 内容: 選択した種別の打刻記録一覧

### 月次集計
- ファイル名: `出退勤記録_YYYY-MM_授業.csv` または `_会議.csv`
- 内容: 講師別の出勤回数、単位数、時間数

## ファイル構成

```
KinTouch/
├── 出退勤確認システム_dual.py  # 複数リーダー対応版（新）
├── 出退勤確認システム.py       # 元のシングルリーダー版
├── 出退勤確認システム_backup.py # バックアップ
├── reader_config.json          # リーダー設定ファイル
├── data/
│   ├── attendance.db           # データベース
│   └── instructors.csv         # 講師マスタ
└── log/
    └── YYYY-MM/                # 月別ログフォルダ
        ├── attendance_records_YYYY-MM-DD_授業.csv
        ├── attendance_records_YYYY-MM-DD_会議.csv
        └── old/                # 過去のエクスポート
```

## 使用方法

### 起動
```bash
python 出退勤確認システム_dual.py
```

### 初回起動時
1. リーダー設定画面が表示される
2. 授業用・会議用のリーダーを選択
3. 「設定を保存」をクリック
4. メニュー画面に移動

### 打刻受付
1. メニューから「1. 打刻受付」を選択
2. 左側（授業用）または右側（会議用）にカードをかざす
3. 打刻情報が3秒間表示される
4. 自動的に出勤/退勤が判定される

### 講師登録
1. メニューから「2. 講師一覧」を選択
2. 「講師登録」ボタンをクリック
3. 使用するリーダーを選択（授業用/会議用どちらでも可）
4. カードをかざす
5. 講師情報を入力して「登録」

### 集計・エクスポート
1. メニューから「7. 日次集計」または「8. 月次集計」を選択
2. 種別（授業用/会議用）を選択
3. 日付または月を入力
4. 「エクスポート」をクリック

## リーダー設定の変更

リーダーの割り当てを変更する場合：
1. メニューから「9. リーダー設定」を選択
2. 新しい割り当てを選択
3. 「設定を保存」をクリック

## 注意事項

- 2台のリーダーが接続されていない場合、エラーメッセージが表示されます
- 講師マスタは授業用・会議用で共通です（同じカードで両方の打刻が可能）
- データベースは1つですが、テーブルは `time_records` と `meeting_records` に分かれています
- 既存の `time_records` データは保持されます（授業用として扱われます）

## トラブルシューティング

### リーダーが検出されない
- USB接続を確認
- デバイスマネージャーでリーダーを確認
- システムを再起動

### 設定がリセットされる
- `reader_config.json` が削除されている可能性
- 再度リーダー設定を実行

### データベースエラー
- `data/attendance.db` のバックアップを取る
- 必要に応じて再作成

## バージョン情報

- **Version**: 2.0（複数リーダー対応版）
- **Date**: 2026-01-30
- **Author**: KinTouch Development Team

## 従来版との違い

| 機能 | 従来版 | 複数リーダー対応版 |
|------|--------|-------------------|
| リーダー数 | 1台 | 2台 |
| データテーブル | time_records のみ | time_records + meeting_records |
| 打刻受付画面 | 1画面 | 2分割画面 |
| 集計機能 | 単一 | 種別選択可能 |
| ウィンドウサイズ | 700x550 | 900x600 |

## ライセンス

このソフトウェアは教育機関での使用を目的として開発されています。